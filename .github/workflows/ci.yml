name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Run ESLint
        run: pnpm run lint

      - name: Run Stylelint
        run: pnpm run lint:css

      - name: Check formatting
        run: pnpm run format:check

      - name: Validate manifest.json
        run: |
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            console.log('✓ manifest.json is valid JSON');
            console.log('  Name:', manifest.name);
            console.log('  Version:', manifest.version);
            if (!manifest.manifest_version) throw new Error('Missing manifest_version');
            if (!manifest.name) throw new Error('Missing name');
            if (!manifest.version) throw new Error('Missing version');
            console.log('✓ Required fields present');
          "

  build:
    name: Build CSS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build CSS
        run: pnpm run build:css

      - name: Check for uncommitted CSS changes
        run: |
          if [ -n "$(git status --porcelain src/*.css docs/*.css 2>/dev/null)" ]; then
            echo "::warning::CSS files are out of sync with SCSS sources"
            echo "Run 'just build' locally and commit the changes"
            git diff --stat src/*.css docs/*.css 2>/dev/null || true
          else
            echo "✓ CSS files are in sync with SCSS sources"
          fi
