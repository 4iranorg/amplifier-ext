name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release zip
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          zip -r "amplifier-v${VERSION}.zip" \
            manifest.json \
            src/content/ \
            src/background/ \
            src/popup/ \
            src/dashboard/ \
            src/onboarding/ \
            src/lib/ \
            icons/ \
            PRIVACY.md \
            TERMS.md \
            -x "*.scss"

      - name: Extract changelog for version
        id: changelog
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          # Extract section for this version from CHANGELOG.md
          changelog=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          # Handle multi-line output
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: amplifier-v${{ steps.version.outputs.VERSION }}.zip
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          prerelease: ${{ startsWith(steps.version.outputs.VERSION, '0.') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
